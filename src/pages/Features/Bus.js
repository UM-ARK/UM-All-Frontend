import React, { Component } from 'react';
import {
    Text,
    View,
    TouchableOpacity,
    StyleSheet,
    Image,
    ImageBackground,
    ScrollView,
    RefreshControl,
} from 'react-native';

// ÂºïÂÖ•Êú¨Âú∞Â∑•ÂÖ∑
import { COLOR_DIY, uiStyle, } from '../../utils/uiMap';
import { UM_BUS_LOOP_ZH, UM_BUS_LOOP_EN, UM_MAP, } from '../../utils/pathMap';
import { openLink } from '../../utils/browser';
import { logToFirebase } from '../../utils/firebaseAnalytics';
import Header from '../../components/Header';
import LoadingDotsDIY from '../../components/LoadingDots';
import { trigger } from '../../utils/trigger';

import Ionicons from 'react-native-vector-icons/Ionicons';
import Modal from 'react-native-modal';
import { DOMParser } from "react-native-html-parser";
import { scale, verticalScale } from 'react-native-size-matters';
import axios from 'axios';
import Toast from 'react-native-toast-message';
import TouchableScale from "react-native-touchable-scale";
import AsyncStorage from '@react-native-async-storage/async-storage';
import { t } from 'i18next';

const { bg_color, white, black, themeColor, secondThemeColor, viewShadow } =
    COLOR_DIY;
// const { width: PAGE_WIDTH } = Dimensions.get('window'); // screen ÂåÖÊã¨navi bar
// const { height: PAGE_HEIGHT } = Dimensions.get('window');

let busIcon = require('../../static/img/Bus/bus.png');
let busRouteImg = require('../../static/img/Bus/bus_route.png');
let stopImgArr = [
    require('../../static/img/Bus/stopImg/PGH.jpg'),
    require('../../static/img/Bus/stopImg/E4.jpg'),
    require('../../static/img/Bus/stopImg/N2.jpg'),
    require('../../static/img/Bus/stopImg/N6.jpg'),
    require('../../static/img/Bus/stopImg/E11.jpg'),
    require('../../static/img/Bus/stopImg/E21.jpg'),
    require('../../static/img/Bus/stopImg/E32.jpg'),
    require('../../static/img/Bus/stopImg/S4.jpg'),
];

// Ëß£Êûêcampus BusÁöÑHTML
function getBusData(busInfoHtml) {
    // ‰ΩøÁî®Á¨¨‰∏âÊñπÊèí‰ª∂react-native-html-parserÔºå‰ª•‰ΩøÁî®DomParserÔºàÁÇ∫‰∫ÜÊá∂ÂØ´‰ª£Á¢ºÔºåË§áÁî®VueÂØ´ÁöÑËß£ÊûêÈÇèËºØÔºâ
    // https://bestofreactjs.com/repo/g6ling-react-native-html-parser-react-native-utilities
    let doc = new DOMParser().parseFromString(busInfoHtml, 'text/html');

    // ‰∏ªË¶ÅÁöÑÂ∑¥Â£´Ë≥áË®äÈÉΩÂ≠òÊîæÂú®spanÂÖß
    let mainInfo = doc.getElementsByTagName('span');
    let busInfoArr = new Array();

    // Âà∞Á´ôÊôÇËªäÁâåÂ±¨ÊñºspanÔºà13ÂÄãspanÔºâ„ÄÇÊú™Âà∞Á´ôÊôÇËªäÁâåÂ±¨ÊñºdivÔºà12ÂÄãspanÔºâ
    // ÁÑ°ËªäÊúçÂãôÊôÇÂè™Êúâ0~2ÁöÑ‰∏ãÊ®ôÁÇ∫busInfoÔºà11ÂÄãspanÔºâ„ÄÇÊúâËªäÊúçÂãôÊôÇÔºå0~3ÁöÑ‰∏ãÊ®ôÈÉΩÊòØbusInfoÔºàËá≥Â∞ë12ÂÄãspanÔºâ
    let infoIndex = mainInfo.length >= 12 ? 3 : 2;

    // ÂàÜÈöîËªäËºõÈÅãË°åË≥áË®ä
    for (let i = 0; i < mainInfo.length; i++) {
        let text = mainInfo[i].textContent;
        if (i <= infoIndex) {
            busInfoArr.push(text);
        } else {
            break;
        }
    }
    // console.log("busInfoArrÁÇ∫:",    busInfoArr);

    // ËªäËºõÂíåÁ´ôÈªûÈÉΩÂú®class=mainÁöÑdivÊ®ôÁ±§ÂÖß
    let arriveInfoBuffer = doc.getElementsByClassName('left', false);
    // console.log("Â∑¥Â£´Âà∞ÈÅîË≥áË®äHTMLÁØÄÈªûÂΩ¢Âºè:",arriveInfoBuffer);

    // Â∞áÁØÄÈªûÊñáÂ≠óÊï∏ÊìöÂ≠òÂÖ•ArrayÔºåÁî®Êñº‰ª•ËªäÁâåÂà§Êñ∑Â∑¥Â£´Âà∞ÈÅî‰ΩçÁΩÆ
    let arriveInfoArr = [];
    // Ëß£ÊûêÂ∑¥Â£´Âà∞Á´ôÊï∏Êìö
    for (let i = 0; i < arriveInfoBuffer.length; i++) {
        let item = arriveInfoBuffer[i].textContent;
        // Âà™Èô§Â≠óÁ¨¶‰∏≤ÂÖßÁöÑ\t \n
        arriveInfoArr.push(item.replace(/[\t\n]/g, ''));
    }
    // index 0ÔºöPGH Á´ôÈªû
    // 1ÔºöPGH ~ E4 Ë∑Ø‰∏ä
    // 2ÔºöE4 Á´ôÈªûÔºå‰ª•Ê≠§È°ûÊé®
    // 15ÔºöS4 ‰∏ãÊñπÁöÑËôõÁÑ°Á´ô
    // console.log("Â∑¥Â£´Âà∞Á´ôÁãÄÊÖãÊï∏ÁµÑÁÇ∫:",arriveInfoArr);

    // Âà§Êñ∑ÁõÆÂâçÊúâÁÑ°Â∑¥Â£´
    let busPositionArr = [];
    for (let i = 0; i < arriveInfoArr.length; i++) {
        let item = arriveInfoArr[i];
        if (item.length > 0) {
            busPositionArr.push({
                number: item,
                index: i,
            });
        }
    }
    // console.log("BusËªäÁâå„ÄÅ‰ΩçÁΩÆÁ∏ΩÊï∏ÊìöÔºö",busPositionArr);

    return {
        busInfoArr,
        busPositionArr,
    };
}

let BUS_URL = UM_BUS_LOOP_ZH;

// Â∑¥Â£´Â†±Á´ôÈ†Å - Áï´Èù¢‰ΩàÂ±ÄËàáÊ∏≤Êüì
class BusScreen extends Component {
    timer = null;

    state = {
        busPositionArr: [],
        // Example: busPositionArr: [{index: 0}],
        busInfoArr: [],
        // ÂΩàÂá∫Â±§ÈªòË™çÈóúÈñâ
        isModalVisible: false,
        // ÂΩàÂá∫Â±§ÂÖßÂÆπ
        modalContent: ['text', 'stopImage', 'busName'],
        // ÈªûÊìäÁ´ôÈªûÁöÑÊï∏ÁµÑÁ¥¢Âºï
        clickStopIndex: 0,
        isLoading: true,
        toastColor: themeColor,
    };

    async componentDidMount() {
        BUS_URL = await AsyncStorage.getItem('language').then(res => {
            const lng = JSON.parse(res);
            // Áï∂ÁÇ∫‰∏≠ÊñáË®≠ÁΩÆ
            if (lng != 'tc') {
                return UM_BUS_LOOP_EN;
            } else {
                return UM_BUS_LOOP_ZH;
            }
        })

        logToFirebase('openPage', { page: 'bus' });
        // ÊâìÈñãBusÈ†ÅÊôÇÁõ¥Êé•Ë´ãÊ±ÇÂ∑¥Â£´Â†±Á´ôÁöÑÊï∏Êìö
        this.fetchBusInfo();

        // ÂÆöÊôÇËá™ÂãïÂà∑Êñ∞Â∑¥Â£´Êï∏Êìö
        this.timer = setInterval(() => {
            // this.onRefresh();
            this.fetchBusInfo();
        }, 7000);
    }

    componentWillUnmount() {
        clearInterval(this.timer);
    }

    // Áà¨Ëü≤campus Bus
    fetchBusInfo = async () => {
        await axios.get(BUS_URL)
            .then(res => getBusData(res.data))
            .then(result => {
                // TODO: busInfoArrÊúçÂãôÊ≠£Â∏∏ÊôÇÔºåÊúâÊôÇlengthÁÇ∫3ÔºåÊúâÊôÇÁÇ∫4„ÄÇÁÇ∫4ÊôÇÁº∫Â§±‚Äú‰∏ã‰∏ÄÁè≠ËªäÊôÇÈñì‚ÄùË≥áË®ä„ÄÇ
                result.busInfoArr.shift(); // ÁßªÈô§Êï∏ÁµÑÁ¨¨‰∏Ä‰ΩçÁöÑ ‚ÄúÊæ≥Â§ßÁí∞Ê†°Á©øÊ¢≠Â∑¥Â£´Â†±Á´ôË≥áË®ä‚Äù Â≠óÁ¨¶‰∏≤

                this.setState({
                    busInfoArr: result.busInfoArr,
                    busPositionArr: result.busPositionArr,
                    haveBus: result.busPositionArr.length > 0 ? true : false,
                    isLoading: false,
                });
                if (this.state.busPositionArr.length == 0) {
                    this.setState({ toastColor: COLOR_DIY.warning });
                    Toast.show({
                        type: 'warning',
                        text1: 'Áï∂ÂâçÊ≤íÊúâÂ∑¥Â£´~',
                        text2: '[]~(Ôø£‚ñΩÔø£)~* üëã',
                        topOffset: scale(100),
                        onPress: () => Toast.hide(),
                    });
                } else {
                    this.setState({ toastColor: themeColor });
                    Toast.show({
                        type: 'arkToast',
                        text1: 'Data is Loading~',
                        text2: 'Âπ´‰Ω†Âà∑Êñ∞‰∫Ü‰∏Ä‰∏ã~ []~(Ôø£‚ñΩÔø£)~* üëã',
                        topOffset: scale(100),
                        onPress: () => Toast.hide(),
                    });
                }
            })
            .catch(error => {
                this.setState({ toastColor: COLOR_DIY.warning });
                Toast.show({
                    type: 'error',
                    text1: 'Á∂≤Áµ°ÈåØË™§ÔºÅ',
                    topOffset: scale(100),
                    onPress: () => Toast.hide(),
                });
            });
    };

    // Â∑¥Â£´Á´ôÈªûÊñáÂ≠óÊ∏≤Êüì
    renderBusStopText = (left, top, buildingCode, text, index) => {
        const { busPositionArr } = this.state;
        let borderColor = themeColor;
        if (busPositionArr.length > 0) {
            busPositionArr.map(item => {
                if (item.index / 2 == index) {
                    borderColor = secondThemeColor;
                }
            });
        }

        return (
            <TouchableScale
                onPress={this.toggleModal.bind(this, index)}
                style={{
                    position: 'absolute', left: scale(left), top: scale(top),
                    paddingHorizontal: scale(5), paddingVertical: scale(2),
                    alignItems: 'center', justifyContent: 'center',
                    borderColor, borderRadius: scale(20), borderWidth: scale(2),
                }}>
                <Text style={{ ...uiStyle.defaultText, color: borderColor, fontSize: scale(11), fontWeight: 'bold' }}>
                    {buildingCode}
                    <Text style={{ ...uiStyle.defaultText, fontWeight: 'normal' }}>{' ' + text}</Text>
                </Text>
            </TouchableScale>
        );
    };

    // ÊéßÂà∂ÂΩàÂá∫Â±§ÊâìÈñã or ÈóúÈñâ
    toggleModal = index => {
        trigger();
        this.setState({
            isModalVisible: !this.state.isModalVisible,
            clickStopIndex: index,
        });
    };

    onRefresh = () => {
        this.setState({ isLoading: true });
        this.fetchBusInfo();
    };

    render() {
        let busStyleArr = [
            // Â∑¥Â£´Âà∞ÈÅî‰ΩçÁΩÆÔºå0ÁÇ∫PGHÔºå1ÁÇ∫PGH~E4Ë∑Ø‰∏äÔºå2ÁÇ∫E4
            { position: 'absolute', left: scale(255), top: scale(450) }, // PGH
            { position: 'absolute', left: scale(255), top: scale(380) }, // PGH ~ E4
            { position: 'absolute', left: scale(255), top: scale(300) }, // E4
            { position: 'absolute', left: scale(255), top: scale(200) }, // E4 ~ N2
            { position: 'absolute', left: scale(255), top: scale(80) }, // N2
            { position: 'absolute', left: scale(160), top: scale(30) }, // N2 ~ N6
            { position: 'absolute', left: scale(75), top: scale(58) }, // N6
            { position: 'absolute', left: scale(30), top: scale(120) }, // N6 ~ E11
            { position: 'absolute', left: scale(30), top: scale(155) }, // E11
            { position: 'absolute', left: scale(30), top: scale(210) }, // E11 ~ E21
            { position: 'absolute', left: scale(30), top: scale(265) }, // N21
            { position: 'absolute', left: scale(30), top: scale(330) }, // N21 ~ E32
            { position: 'absolute', left: scale(30), top: scale(390) }, // E32
            { position: 'absolute', left: scale(30), top: scale(500) }, // E32 ~ S4
            { position: 'absolute', left: scale(190), top: scale(493) }, // s4
            { position: 'absolute', left: scale(255), top: scale(500) }, // s4 ~ PGH
        ];

        const { busPositionArr, busInfoArr, toastColor, isLoading } = this.state;

        return (
            <View style={{ flex: 1, backgroundColor: bg_color }}>
                <Header title={t('Ê†°ÂúíÂ∑¥Â£´', { ns: 'features' })} />

                <ScrollView
                    bounces={false}
                    refreshControl={
                        <RefreshControl
                            colors={[themeColor]}
                            tintColor={themeColor}
                            refreshing={isLoading}
                            onRefresh={this.onRefresh}
                        />
                    }>
                    <ScrollView horizontal={false}>
                        <ImageBackground
                            style={{
                                width: scale(310),
                                height: scale(600),
                                marginLeft: scale(25),
                                marginBottom: scale(40),
                            }}
                            source={busRouteImg}
                            resizeMode={'contain'}>
                            {/* Data From */}
                            <View
                                style={{
                                    ...s.infoContainer,
                                    left: scale(60),
                                    top: scale(575),
                                    marginTop: scale(10),
                                }}>
                                <Text
                                    style={{ ...uiStyle.defaultText, fontSize: scale(12), color: black.third }}>
                                    Data From: cmdo.um.edu.mo
                                </Text>
                            </View>
                            {/* Êæ≥Â§ßÂú∞Âúñ */}
                            <TouchableOpacity
                                style={{
                                    ...s.infoContainer,
                                    left: scale(110),
                                    top: scale(350),
                                }}
                                onPress={() => {
                                    trigger();
                                    // Linking.openURL(UM_MAP);
                                    // const webview_param = {
                                    //     url: UM_MAP,
                                    //     title: 'Ê†°ÂúíÂú∞Âúñ',
                                    //     text_color: black.main,
                                    //     bg_color_diy: '#ffffff',
                                    //     isBarStyleBlack: true,
                                    // };
                                    // this.props.navigation.navigate('Webviewer', webview_param);
                                    openLink(UM_MAP);
                                }}
                            >
                                <Text style={{ ...uiStyle.defaultText, fontSize: scale(11), color: themeColor, fontWeight: 'bold' }}>{t('Ê†°ÂúíÂú∞Âúñ', { ns: 'features' })}</Text>
                            </TouchableOpacity>
                            {/* BusÈÅãË°å‰ø°ÊÅØÁöÑÊ∏≤Êüì */}
                            <View
                                style={{
                                    ...s.infoContainer,
                                    left: scale(65),
                                    top: scale(185),
                                    width: scale(160),
                                }}>
                                {busInfoArr.length > 0
                                    ? this.state.busInfoArr.map(item => (
                                        <Text
                                            style={{
                                                ...uiStyle.defaultText,
                                                color: black.third,
                                                fontSize: scale(10),
                                            }}>
                                            {item}
                                        </Text>
                                    ))
                                    : null}
                            </View>

                            {/* Â∑¥Â£´ÂúñÊ®ô */}
                            {busPositionArr.length > 0
                                ? busPositionArr.map(item => (
                                    <TouchableScale style={busStyleArr[item.index]} activeScale={0.6}
                                        onPress={() => {
                                            trigger();
                                            this.fetchBusInfo();
                                        }}>
                                        <Image
                                            source={busIcon}
                                            style={{
                                                width: scale(30),
                                                height: scale(30),
                                            }}
                                        />
                                    </TouchableScale>
                                ))
                                : null}

                            {/* Â∑¥Â£´Á´ôÈªûÊñáÂ≠ó */}
                            {this.renderBusStopText(100, 455, 'PGH', 'Á†îÁ©∂ÁîüÂÆøËàç(Ëµ∑)', 0)}
                            {this.renderBusStopText(145, 302, 'E4', 'ÂäâÂ∞ëÊ¶ÆÊ®ì', 1)}
                            {this.renderBusStopText(145, 82, 'N2', 'Â§ßÂ≠∏ÊúÉÂ†Ç', 2)}
                            {this.renderBusStopText(45, 90, 'N6', 'Ë°åÊîøÊ®ì', 3)}
                            {this.renderBusStopText(79, 160, 'E11', 'ÁßëÊäÄÂ≠∏Èô¢', 4)}
                            {this.renderBusStopText(79, 267, 'E21', '‰∫∫ÊñáÁ§æÁßëÊ®ì', 5)}
                            {this.renderBusStopText(79, 395, 'E32', 'Ê≥ïÂ≠∏Èô¢', 6)}
                            {this.renderBusStopText(80, 547, 'S4', 'Á†îÁ©∂ÁîüÂÆøËàçÂçóÂõõÂ∫ß(ÁµÇ)', 7)}

                            <View style={{
                                position: 'absolute',
                                top: scale(5),
                                left: scale(130),
                                width: scale(35),
                            }}>
                                <LoadingDotsDIY />
                            </View>
                        </ImageBackground>
                    </ScrollView>
                </ScrollView>

                {/* ÂΩàÂá∫Â±§ - Â±ïÁ§∫Á´ôÈªûÂúñÁâá */}
                <Modal
                    isVisible={this.state.isModalVisible}
                    onBackdropPress={this.toggleModal.bind(
                        this,
                        this.state.clickStopIndex,
                    )}
                    animationIn="zoomIn"
                    animationOut="zoomOut"
                    animationInTiming={500}
                    animationOutTiming={500}
                    backdropOpacity={0.4}
                    backdropTransitionOutTiming={500}>
                    <View
                        style={{
                            justifyContent: 'center',
                            alignItems: 'center',
                        }}>
                        {/* ÈóúÈñâÂúñÊ®ô - ÂºïÂ∞éÁî®Êà∂ÈªûÊìäËÉåÊôØÈóúÈñâÂΩàÂá∫Â±§ */}
                        <TouchableOpacity
                            style={{
                                position: 'absolute',
                                right: scale(5),
                                top: scale(45)
                            }}
                            onPress={this.toggleModal.bind(
                                this,
                                this.state.clickStopIndex,
                            )}>
                            <Ionicons
                                name={'close-circle'}
                                size={scale(35)}
                                color={white}
                            />
                        </TouchableOpacity>
                        <Image
                            source={stopImgArr[this.state.clickStopIndex]}
                            style={{ height: '60%' }}
                            resizeMode="contain"
                        />
                    </View>
                </Modal>
            </View>
        );
    }
}

const s = StyleSheet.create({
    container: {
        flex: 1,
        flexDirection: 'column',
    },
    arrowSize: {
        width: scale(35),
        height: scale(35),
        resizeMode: 'contain',
    },
    dotSize: {
        width: scale(21),
        height: scale(21),
        resizeMode: 'contain',
    },
    infoContainer: {
        position: 'absolute',
        marginHorizontal: scale(10),
        backgroundColor: white,
        borderRadius: scale(10),
        ...viewShadow,
        paddingHorizontal: scale(10),
        paddingVertical: scale(3),
    },
});

export default BusScreen;
